<!DOCTYPE html>
<html lang="ja">
<head>

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Firebase P2P LINE風チャット</title>
<style>
:root{--bg:#0b1220;--card:#111a2b;--ink:#e6f0ff;--muted:#9fb0d1;--accent:#62a1ff;--me:#1a73e8;--other:#3c4043}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{padding:16px;text-align:center;background:var(--card)}
h1{margin:0;font-size:20px}
main{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px}
@media(max-width:980px){main{grid-template-columns:1fr}}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
input,textarea,button{border-radius:8px;border:none;padding:8px;background:#0f1a2e;color:var(--ink)}
button{cursor:pointer}
button.primary{background:var(--accent);color:#000}
#peers{max-height:150px;overflow:auto;border:1px dashed #273a63;padding:8px;margin:6px 0;border-radius:8px}
#chatlog{height:400px;overflow:auto;padding:8px;margin:8px 0;border-radius:12px;background:#111a2b;display:flex;flex-direction:column;gap:6px}
.msg{padding:8px 12px;border-radius:16px;max-width:70%;word-break:break-word}
.me{background:var(--me);align-self:flex-end}
.other{background:var(--other);align-self:flex-start}
.sys{align-self:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
<h1>Firebase P2P LINE風チャット</h1>
<p>名前を入力してホスト開始 or ゲスト参加</p>
</header>
<main>
<section class="card">
<label class="row"><span>あなたの名前:</span><input id="nickname" placeholder="例：たろう"></label>
<div class="row"><button id="btnHost" class="primary">ホスト開始</button><button id="btnGuest">ゲスト参加</button></div>
<div id="hostArea" style="display:none">
<h4>接続中のゲスト</h4>
<div id="peers"></div>
</div>
<div id="guestArea" style="display:none">
<p>ホストからのRoomIDをURL末尾に付けてアクセス</p>
</div>
</section>

<section class="card">
<div id="chatlog"></div>
<div class="row">
<input id="message" placeholder="メッセージ入力" disabled>
<button id="send" disabled>送信</button>
</div>
</section>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// ===== Firebase 設定 =====
const firebaseConfig = {
  apiKey: "AIzaSyCUD3UUI_Q9Wy1V639hX1hC7ouCUYHXl2A",
  authDomain: "p2p-chat-b14da.firebaseapp.com",
  databaseURL: "https://p2p-chat-b14da-default-rtdb.firebaseio.com",
  projectId: "p2p-chat-b14da",
  storageBucket: "p2p-chat-b14da.firebasestorage.app",
  messagingSenderId: "436732488132",
  appId: "1:436732488132:web:82c3ab560c6e86df42dc91",
  measurementId: "G-SHGGG477HM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== 便利関数 =====
const $ = s=>document.querySelector(s);
const myName = ()=>$('#nickname').value.trim()||'匿名';
const addMsg = (kind,text,name)=>{
  const log=$('#chatlog');
  const div=document.createElement('div');
  div.className=kind==='me'?'msg me':kind==='other'?'msg other':'msg sys';
  div.textContent=(name?name+': ':'')+text;
  log.appendChild(div);
  log.scrollTop=log.scrollHeight;
};

// ===== WebRTC =====
const rtcConfig={iceServers:[]};
const peers = new Map();
let mode=null;

// データチャンネル束ね
function wireDC(dc,id){
  dc.onopen=()=>{
    addMsg('sys','接続成功: '+peers.get(id).name);
    dc.send(JSON.stringify({type:'hello',name:myName()}));
    updateUI();
  };
  dc.onmessage=e=>{
    try{const d=JSON.parse(e.data);if(d.type==='hello'){peers.get(id).name=d.name;updateUI();return;}}catch(_){}
    addMsg('other',e.data,peers.get(id).name);
    saveMessage(peers.get(id).name,e.data);
  };
  dc.onclose=()=>{ addMsg('sys',peers.get(id)?.name+' 接続終了'); updateUI(); };
}

// UI更新
function updateUI(){
  $('#peers').innerHTML='';
  peers.forEach((p,id)=>{
    const div=document.createElement('div');
    div.textContent=p.name+' ('+(p.dc?p.dc.readyState:'新規')+')';
    $('#peers').appendChild(div);
  });
  const anyOpen=[...peers.values()].some(p=>p.dc&&p.dc.readyState==='open');
  $('#message').disabled=!anyOpen; $('#send').disabled=!anyOpen;
}

// ===== Firestoreメッセージ保存 =====
let messagesRef;
function saveMessage(name,text){
  if(!messagesRef) return;
  messagesRef.add({name,text,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
}
function listenMessages(){
  messagesRef.onSnapshot(snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==='added'){
        const data=change.doc.data();
        const kind=data.name===myName()?'me':'other';
        addMsg(kind,data.text,data.name);
      }
    });
  });
}

// ===== ホスト =====
$('#btnHost').onclick=async()=>{
  mode='host';
  $('#hostArea').style.display='block';
  $('#guestArea').style.display='none';
  addMsg('sys','ホストモード');

  const roomId=crypto.randomUUID();
  const roomDoc = db.collection('rooms').doc(roomId);
  messagesRef=roomDoc.collection('messages');
  listenMessages();

  const pc = new RTCPeerConnection(rtcConfig);
  const dc = pc.createDataChannel('chat');
  const id=crypto.randomUUID();
  peers.set(id,{pc,dc,name:myName()});
  wireDC(dc,id);
  pc.onconnectionstatechange=updateUI;
  pc.onicecandidate=e=>{ if(e.candidate) roomDoc.collection('offerCandidates').add(e.candidate.toJSON()); };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await roomDoc.set({offer});
  addMsg('sys','Room作成: #'+roomId);
  location.hash=roomId;
};

// ===== ゲスト =====
$('#btnGuest').onclick=async()=>{
  mode='guest';
  $('#hostArea').style.display='none';
  $('#guestArea').style.display='block';
  const roomId = location.hash.substring(1);
  if(!roomId){ alert('URL末尾にRoomIDを付けてください'); return; }
  const roomDoc = db.collection('rooms').doc(roomId);
  messagesRef=roomDoc.collection('messages');
  listenMessages();

  const callData = (await roomDoc.get()).data();
  const pc = new RTCPeerConnection(rtcConfig);
  const id=crypto.randomUUID();
  peers.set(id,{pc,dc:null,name:'ホスト'});
  pc.ondatachannel=ev=>{ peers.get(id).dc=ev.channel; wireDC(ev.channel,id); };
  pc.onconnectionstatechange=updateUI;
  pc.onicecandidate=e=>{ if(e.candidate) roomDoc.collection('answerCandidates').add(e.candidate.toJSON()); };
  await pc.setRemoteDescription(callData.offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await roomDoc.update({answer});
  addMsg('sys','ゲスト参加完了');
};

// ===== チャット送信 =====
$('#send').onclick=()=>{
  const text=$('#message').value.trim();
  if(!text) return;
  addMsg('me',text,myName());
  saveMessage(myName(),text);
  peers.forEach(p=>{if(p.dc&&p.dc.readyState==='open') p.dc.send(text);});
  $('#message').value='';
};
$('#message').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ $('#send').click(); e.preventDefault(); } });
</script>
</body>
</html>
