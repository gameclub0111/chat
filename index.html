<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>マルチルームLINE風チャット（通知音付き）</title>
<style>
:root{
  --bg:#e0f7fa;
  --card:#ffffff;
  --ink:#1a1a1a;
  --muted:#555555;
  --accent:#4fc3f7;
  --me:#81d4fa;
  --other:#b3e5fc;
  --host:#ffd54f;
  --guest:#aed581;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--ink);
}
header{
  padding:16px;
  text-align:center;
  background:var(--accent);
  color:#000;
  font-weight:bold;
}
main{
  display:grid;
  grid-template-columns:300px 1fr;
  gap:16px;
  padding:16px;
}
@media(max-width:980px){main{grid-template-columns:1fr}}
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:6px;
}
input,textarea,button{
  border-radius:8px;
  border:1px solid #ccc;
  padding:8px;
  background:#fff;
  color:var(--ink);
  width:100%;
}
button{
  cursor:pointer;
}
button.primary{
  background:var(--accent);
  color:#000;
}
#chatlog{
  height:400px;
  overflow:auto;
  padding:8px;
  margin:8px 0;
  border-radius:12px;
  background:#f0f8ff;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.msg{
  padding:8px 12px;
  border-radius:16px;
  max-width:70%;
  word-break:break-word;
  position:relative;
}
.msg .time{
  font-size:10px;
  color:var(--muted);
  position:absolute;
  bottom:2px;
  right:8px;
}
.me{background:var(--me);align-self:flex-end}
.other{background:var(--other);align-self:flex-start}
.sys{align-self:center;font-size:12px;color:var(--muted)}
.tag{font-size:10px;font-weight:bold;padding:2px 6px;border-radius:6px;margin-left:6px}
.host{background:var(--host);}
.guest{background:var(--guest);}
</style>
</head>
<body>
<header>
マルチルームLINE風チャット
<p>名前を入力してホスト開始 or ゲスト参加</p>
</header>
<main>
<section class="card">
<label class="row"><span>あなたの名前:</span><input id="nickname" placeholder="例：たろう"></label>
<div class="row">
<button id="btnHost" class="primary">ホスト開始</button>
<button id="btnGuest">ゲスト参加</button>
</div>
<div id="hostInfo" style="display:none">
<p>RoomID: <span id="roomIdDisplay"></span></p>
</div>
</section>

<section class="card">
<div id="chatlog"></div>
<div class="row">
<input id="message" placeholder="メッセージ入力" disabled>
<button id="send" disabled>送信</button>
</div>
</section>

<!-- 通知音 -->
<audio id="notifySound" src="tuti1.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// ===== Firebase 設定 =====
const firebaseConfig = {
  apiKey: "AIzaSyCUD3UUI_Q9Wy1V639hX1hC7ouCUYHXl2A",
  authDomain: "p2p-chat-b14da.firebaseapp.com",
  databaseURL: "https://p2p-chat-b14da-default-rtdb.firebaseio.com",
  projectId: "p2p-chat-b14da",
  storageBucket: "p2p-chat-b14da.firebasestorage.app",
  messagingSenderId: "436732488132",
  appId: "1:436732488132:web:82c3ab560c6e86df42dc91",
  measurementId: "G-SHGGG477HM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== 便利関数 =====
const $ = s=>document.querySelector(s);
let roomId=null;
let messagesRef=null;
let role=null; // host or guest
const sound = $('#notifySound');
const myName = ()=>$('#nickname').value.trim()||'匿名';
const addMsg = (kind,text,name,roleTag)=>{
  const log=$('#chatlog');
  const div=document.createElement('div');
  div.className=kind==='me'?'msg me':kind==='other'?'msg other':'msg sys';
  const timeSpan=document.createElement('span');
  timeSpan.className='time';
  const d=new Date();
  timeSpan.textContent=`${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
  div.textContent=(name?name+': ':'')+text;
  div.appendChild(timeSpan);
  if(roleTag){
    const span=document.createElement('span');
    span.className='tag '+roleTag;
    span.textContent=roleTag;
    div.appendChild(span);
  }
  log.appendChild(div);
  log.scrollTop=log.scrollHeight;
};

// ===== Firestoreメッセージ =====
function saveMessage(name,text,roleTag){
  if(!messagesRef) return;
  messagesRef.add({name,text,roleTag,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
}
function listenMessages(){
  messagesRef.orderBy('timestamp').onSnapshot(snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==='added'){
        const data=change.doc.data();
        const kind=data.name===myName()?'me':'other';
        addMsg(kind,data.text,data.name,data.roleTag);
        // 自分以外なら通知音
        if(kind==='other'){ sound.currentTime=0; sound.play(); }
      }
    });
  });
}

// ===== ホスト開始 =====
$('#btnHost').onclick=()=>{
  if(!myName()) return alert('名前を入力してください');
  role='host';
  roomId=crypto.randomUUID().slice(0,8);
  $('#hostInfo').style.display='block';
  $('#roomIdDisplay').textContent=roomId;
  messagesRef=db.collection('rooms').doc(roomId).collection('messages');
  listenMessages();
  addMsg('sys','ホストとしてチャット開始');
  $('#message').disabled=false; $('#send').disabled=false;
};

// ===== ゲスト参加 =====
$('#btnGuest').onclick=()=>{
  if(!myName()) return alert('名前を入力してください');
  role='guest';
  const inputId=prompt('参加するRoomIDを入力してください');
  if(!inputId) return alert('RoomIDが必要です');
  roomId=inputId;
  messagesRef=db.collection('rooms').doc(roomId).collection('messages');
  listenMessages();
  addMsg('sys','ゲストとして参加');
  $('#message').disabled=false; $('#send').disabled=false;
};

// ===== チャット送信 =====
$('#send').onclick=()=>{
  const text=$('#message').value.trim();
  if(!text) return;
  addMsg('me',text,myName(),role);
  saveMessage(myName(),text,role);
  $('#message').value='';
};
$('#message').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ $('#send').click(); e.preventDefault(); } });
</script>
</body>
</html>
